import{_ as we,a as Ie,A as ze,b as Ve,L as $e,S as Ue,c as De,d as Se}from"./SLASection-ffc44f4e.js";import{D as Ae,C as Ne,Q as j,a1 as Be,a2 as Ee,H as Me,G as v,c as S,s as L,o as u,b as _,u as t,a as y,w as d,k as p,f as l,F as O,K as x,J as z,a3 as P,P as q,a4 as Te,a5 as Fe,a6 as Re,a7 as je,n as A,N as Y,a8 as Le,d as c,t as C,a9 as Oe,M as V,L as Z,ab as N,ac as Pe,x as ee,ad as ae,af as qe,aB as We,j as te,ar as Ge}from"./index-fd4111d0.js";import{I as He}from"./IndicatorIcon-b09272ab.js";import{S as Je}from"./Fields-0f4da799.js";import{_ as Ke,a as Qe}from"./LayoutHeader-4431816a.js";import{_ as Xe}from"./OrganizationModal-1758a6c2.js";import{s as Ye,_ as Ze}from"./statuses-ded37fc4.js";import{C as ea}from"./ContactModal-891a8f63.js";import{_ as aa}from"./CustomActions-78928ae0.js";import{o as ta}from"./organizations-47b1381a.js";import{c as se,w as sa}from"./settings-c0b8fd73.js";import{_ as la}from"./Tabs-9726eea5.js";import"./FileUploader-3fcaee7d.js";import"./FadedScrollableDiv-b9eabb0e.js";import"./CalendarIcon-7eb5de62.js";import"./EmailTemplateModal-754da216.js";import"./TaskModal-3d86a4d5.js";import"./DatetimePicker-76bd67f8.js";import"./EditIcon-fc06c5a8.js";const oa={key:1,class:"flex h-full overflow-hidden"},na={class:"flex items-center justify-start gap-5 border-b p-5"},ia={class:"group relative size-12"},ra={class:"flex flex-col gap-2.5 truncate"},da={class:"truncate text-2xl font-medium"},ua={class:"flex gap-1.5"},ca={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},ma={class:"flex flex-col overflow-y-auto"},_a={key:0,class:"pr-2"},pa={key:1},fa={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},ga={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},va=["onClick"],ya={class:"truncate"},ha={class:"flex items-center"},ba={class:"flex flex-col gap-1.5 text-base text-gray-800"},xa={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Ca={class:"flex items-center gap-3 p-1 py-1.5"},ka={key:0,class:"mx-2 h-px border-t border-gray-200"},wa={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},qa={__name:"Deal",props:{dealId:{type:String,required:!0}},setup(le){const{$dialog:oe,makeCall:ne}=Ae(),{organizations:ie,getOrganization:re}=ta(),{statusOptions:de,getDealStatus:ue}=Ye(),$=Ne(),f=le,s=j({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:f.dealId},cache:["deal",f.dealId],transform(a){for(let e=0;e<a.doctype_fields.length;e++)for(let r=0;r<a.doctype_fields[e].fields.length;r++)a.doctype_fields[e].fields[r].name=="deal_owner"&&(a.doctype_fields[e].fields[r].hidden_delete=!0);return a},onSuccess:a=>{Be(a),Ee(a,{doc:a,$dialog:oe,router:$,updateField:w,createToast:x,deleteDoc:xe,call:z})}});Me(()=>{s.data||s.fetch()});function ce(){s.fetch()}const B=v(!1),E=v(!1),M=v(!1),T=v({}),k=S(()=>{var a;return((a=s.data)==null?void 0:a.organization)&&re(s.data.organization)});function me(a,e,r){if(e=Array.isArray(a)?"":e,_e(a,e))return;let n=1;j({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:f.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{s.reload(),B.value=!0,x({title:__("Deal updated"),icon:"check",iconClasses:"text-green-600"}),r==null||r()},onError:b=>{var i;n>0&&(x({title:__("Error updating deal"),text:__((i=b.messages)==null?void 0:i[0]),icon:"x",iconClasses:"text-red-600"}),n-=1)}})}function _e(a,e){var n;let r=s.data.all_fields||{};return(n=r[a])!=null&&n.reqd&&!e?(x({title:__("Error Updating Deal"),text:__("{0} is a required field",[r[a].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const pe=S(()=>{var e;let a=[{label:__("Deals"),route:{name:"Deals"}}];return a.push({label:((e=k.value)==null?void 0:e.name)||__("Untitled"),route:{name:"Deal",params:{dealId:s.data.name}}}),a}),U=v(0),fe=S(()=>[{name:"Activity",label:__("Activity"),icon:ze},{name:"Emails",label:__("Emails"),icon:P},{name:"Calls",label:__("Calls"),icon:q,condition:()=>se.value},{name:"Tasks",label:__("Tasks"),icon:Te},{name:"Notes",label:__("Notes"),icon:Fe},{name:"WhatsApp",label:__("WhatsApp"),icon:Re,condition:()=>sa.value}].filter(e=>e.condition?e.condition():!0)),F=S(()=>{let a=s.data;return a?ge(a.doctype_fields,h.data):[]});function ge(a,e){return a.forEach(r=>{r.name=="contacts_tab"?(delete r.fields,r.contacts=(e==null?void 0:e.map(n=>({name:n.name,full_name:n.full_name,email:n.email,mobile_no:n.mobile_no,image:n.image,is_primary:n.is_primary,opened:!1})))||[]):r.fields.forEach(n=>{n.name=="organization"&&(n.create=(b,i)=>{T.value.organization_name=b,E.value=!0,i()},n.link=b=>$.push({name:"Organization",params:{organizationId:b}}),n.hideClear=!0)})}),a}const R=v(!1),W=v({});function ve(a){let e=[{label:__("Delete"),icon:"trash-2",onClick:()=>ye(a)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:Ge(Je,{class:"h-4 w-4"}),onClick:()=>he(a)}),e}async function G(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:f.dealId,contact:a})&&(h.reload(),x({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function ye(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:f.dealId,contact:a})&&(h.reload(),x({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function he(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:f.dealId,contact:a})&&(h.reload(),x({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const h=j({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:f.dealId},cache:["deal_contacts",f.dealId],auto:!0});function be(){var r;let a=(r=h.data)==null?void 0:r.find(n=>n.is_primary),e=a.mobile_no||null;if(!a){N(__("No primary contact set"));return}if(!e){N(__("No mobile number set"));return}ne(e)}function w(a,e,r){me(a,e,()=>{s.data[a]=e,r==null||r()})}async function xe(a){await z("frappe.client.delete",{doctype:"CRM Deal",name:a}),$.push({name:"Deals"})}const H=v(null);function Ce(){H.value.emailBox.show=!0}return(a,e)=>{const r=L("FeatherIcon"),n=L("Button"),b=L("Badge");return u(),_(O,null,[t(s).data?(u(),y(Ke,{key:0},{"left-header":d(()=>[l(t(Qe),{items:pe.value},null,8,["items"])]),"right-header":d(()=>{var i;return[t(s).data._customActions?(u(),y(aa,{key:0,actions:t(s).data._customActions},null,8,["actions"])):p("",!0),(u(),y(je(((i=t(s).data._assignedTo)==null?void 0:i.length)==1?"Button":"div"),null,{default:d(()=>[l(Ze,{avatars:t(s).data._assignedTo,onClick:e[0]||(e[0]=o=>M.value=!0)},null,8,["avatars"])]),_:1})),l(t(Y),{options:t(de)("deal",w)},{default:d(({open:o})=>[l(n,{label:t(s).data.status,class:A(t(ue)(t(s).data.status).colorClass)},{prefix:d(()=>[l(He)]),suffix:d(()=>[l(r,{name:o?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])]}),_:1})):p("",!0),t(s).data?(u(),_("div",oa,[l(t(la),{modelValue:U.value,"onUpdate:modelValue":e[4]||(e[4]=i=>U.value=i),tabs:fe.value},{default:d(({tab:i})=>[l(Ve,{ref_key:"activities",ref:H,doctype:"CRM Deal",title:i.name,reload:B.value,"onUpdate:reload":e[1]||(e[1]=o=>B.value=o),tabIndex:U.value,"onUpdate:tabIndex":e[2]||(e[2]=o=>U.value=o),modelValue:t(s),"onUpdate:modelValue":e[3]||(e[3]=o=>Le(s)?s.value=o:null)},null,8,["title","reload","tabIndex","modelValue"])]),_:1},8,["modelValue","tabs"]),l(we,{side:"right",class:"flex flex-col justify-between border-l"},{default:d(()=>{var i;return[c("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium",onClick:e[5]||(e[5]=o=>t(Oe)(t(s).data.name))},C(a.__(t(s).data.name)),1),c("div",na,[l(t(V),{text:a.__("Organization logo")},{default:d(()=>{var o,D;return[c("div",ia,[l(t(Z),{size:"3xl",class:"size-12",label:((o=k.value)==null?void 0:o.name)||a.__("Untitled"),image:(D=k.value)==null?void 0:D.organization_logo},null,8,["label","image"])])]}),_:1},8,["text"]),c("div",ra,[l(t(V),{text:((i=k.value)==null?void 0:i.name)||a.__("Set an organization")},{default:d(()=>{var o;return[c("div",da,C(((o=k.value)==null?void 0:o.name)||a.__("Untitled")),1)]}),_:1},8,["text"]),c("div",ua,[t(se)?(u(),y(t(V),{key:0,text:a.__("Make a call")},{default:d(()=>[l(n,{class:"h-7 w-7",onClick:be},{default:d(()=>[l(q,{class:"h-4 w-4"})]),_:1})]),_:1},8,["text"])):p("",!0),l(t(V),{text:a.__("Send an email")},{default:d(()=>[l(n,{class:"h-7 w-7"},{default:d(()=>[l(P,{class:"h-4 w-4",onClick:e[6]||(e[6]=o=>t(s).data.email?Ce():t(N)(a.__("No email set")))})]),_:1})]),_:1},8,["text"]),l(t(V),{text:a.__("Go to website")},{default:d(()=>[l(n,{class:"h-7 w-7"},{default:d(()=>[l($e,{class:"h-4 w-4",onClick:e[7]||(e[7]=o=>t(s).data.website?t(Pe)(t(s).data.website):t(N)(a.__("No website set")))})]),_:1})]),_:1},8,["text"])])])]),t(s).data.sla_status?(u(),y(Ue,{key:0,modelValue:t(s).data,"onUpdate:modelValue":e[8]||(e[8]=o=>t(s).data=o),onUpdateField:w},null,8,["modelValue"])):p("",!0),F.value.length?(u(),_("div",ca,[c("div",ma,[(u(!0),_(O,null,ee(F.value,(o,D)=>(u(),_("div",{key:o.label,class:A(["flex flex-col p-3",{"border-b":D!==F.value.length-1}])},[l(ae,{"is-opened":o.opened,label:o.label},{actions:d(()=>[o.contacts?(u(),_("div",_a,[l(qe,{value:"",doctype:"FCRM Contact",onChange:e[9]||(e[9]=g=>G(g)),onCreate:(g,I)=>{W.value={first_name:g,company_name:t(s).data.organization},R.value=!0,I()}},{target:d(({togglePopover:g})=>[l(n,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:I=>g()},null,8,["onClick"])]),_:1},8,["onCreate"])])):p("",!0)]),default:d(()=>{var g,I,J;return[o.fields?(u(),y(De,{key:0,fields:o.fields,modelValue:t(s).data,"onUpdate:modelValue":e[10]||(e[10]=m=>t(s).data=m),onUpdate:w},null,8,["fields","modelValue"])):(u(),_("div",pa,[(g=t(h))!=null&&g.loading&&((J=(I=t(h))==null?void 0:I.data)==null?void 0:J.length)==0?(u(),_("div",fa,[l(Se,{class:"h-4 w-4"}),c("span",null,C(a.__("Loading...")),1)])):o.contacts.length?(u(!0),_(O,{key:1},ee(o.contacts,(m,K)=>(u(),_("div",{key:m.name},[c("div",{class:A(["px-2 pb-2.5",[K==0?"pt-5":"pt-2.5"]])},[l(ae,{"is-opened":m.opened},{header:d(({opened:ke,toggle:Q})=>[c("div",ga,[c("div",{class:"flex h-7 items-center gap-2 truncate",onClick:X=>Q()},[l(t(Z),{label:m.full_name,image:m.image,size:"md"},null,8,["label","image"]),c("div",ya,C(m.full_name),1),m.is_primary?(u(),y(b,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):p("",!0)],8,va),c("div",ha,[l(t(Y),{options:ve(m.name)},{default:d(()=>[l(n,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),l(n,{variant:"ghost",onClick:X=>t($).push({name:"Contact",params:{contactId:m.name}})},{default:d(()=>[l(We,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),l(n,{variant:"ghost",onClick:X=>Q()},{default:d(()=>[l(r,{name:"chevron-right",class:A(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":ke}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:d(()=>[c("div",ba,[c("div",xa,[l(P,{class:"h-4 w-4"}),te(" "+C(m.email),1)]),c("div",Ca,[l(q,{class:"h-4 w-4"}),te(" "+C(m.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),K!=o.contacts.length-1?(u(),_("div",ka)):p("",!0)]))),128)):(u(),_("div",wa,C(a.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):p("",!0)]}),_:1})])):p("",!0),l(Xe,{modelValue:E.value,"onUpdate:modelValue":e[11]||(e[11]=i=>E.value=i),organization:T.value,"onUpdate:organization":e[12]||(e[12]=i=>T.value=i),options:{redirect:!1,afterInsert:i=>w("organization",i.name,()=>{t(ie).reload()})}},null,8,["modelValue","organization","options"]),l(ea,{modelValue:R.value,"onUpdate:modelValue":e[13]||(e[13]=i=>R.value=i),contact:W.value,options:{redirect:!1,afterInsert:i=>G(i.name)}},null,8,["modelValue","contact","options"]),t(s).data?(u(),y(Ie,{key:2,doc:t(s).data,modelValue:M.value,"onUpdate:modelValue":e[14]||(e[14]=i=>M.value=i),assignees:t(s).data._assignedTo,"onUpdate:assignees":e[15]||(e[15]=i=>t(s).data._assignedTo=i),onUpdate:ce},null,8,["doc","modelValue","assignees"])):p("",!0)],64)}}};export{qa as default};
//# sourceMappingURL=Deal-4447f358.js.map
