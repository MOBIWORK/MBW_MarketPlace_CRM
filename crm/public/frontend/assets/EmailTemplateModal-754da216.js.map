{"version":3,"file":"EmailTemplateModal-754da216.js","sources":["../../../../frontend/src/components/Modals/EmailTemplateModal.vue"],"sourcesContent":["<template>\n  <Dialog\n    v-model=\"show\"\n    :options=\"{\n      title: editMode ? __(emailTemplate.name) : __('Create Email Template'),\n      size: 'xl',\n      actions: [\n        {\n          label: editMode ? __('Update') : __('Create'),\n          variant: 'solid',\n          onClick: () => (editMode ? updateEmailTemplate() : callInsertDoc()),\n        },\n      ],\n    }\"\n  >\n    <template #body-content>\n      <div class=\"flex flex-col gap-4\">\n        <div class=\"flex gap-4\">\n          <div class=\"flex-1\">\n            <div class=\"mb-1.5 text-sm text-gray-600\">\n              {{ __('Email name') }}\n              <span class=\"text-red-500\">*</span>\n            </div>\n            <TextInput\n              ref=\"nameRef\"\n              variant=\"outline\"\n              v-model=\"_emailTemplate.name\"\n              :placeholder=\"__('')\"\n            />\n          </div>\n          <div class=\"flex-1\">\n            <div class=\"mb-1.5 text-sm text-gray-600\">{{ __('Doctype') }}</div>\n            <Select\n              variant=\"outline\"\n              v-model=\"_emailTemplate.reference_doctype\"\n              :options=\"['CRM Deal', 'CRM Lead']\"\n              :placeholder=\"__('CRM Deal')\"\n            />\n          </div>\n        </div>\n        <div>\n          <div class=\"mb-1.5 text-sm text-gray-600\">\n            {{ __('Subject') }}\n            <span class=\"text-red-500\">*</span>\n          </div>\n          <TextInput\n            ref=\"subjectRef\"\n            variant=\"outline\"\n            v-model=\"_emailTemplate.subject\"\n            :placeholder=\"__('')\"\n          />\n        </div>\n        <div>\n          <div class=\"mb-1.5 text-sm text-gray-600\">\n            {{ __('Content') }}\n            <span class=\"text-red-500\">*</span>\n          </div>\n          <!-- <TextEditor\n            variant=\"outline\"\n            ref=\"content\"\n            editor-class=\"!prose-sm overflow-auto min-h-[180px] max-h-80 py-1.5 px-2 rounded border border-gray-300 bg-white hover:border-gray-400 hover:shadow-sm focus:bg-white focus:border-gray-500 focus:shadow-sm focus:ring-0 focus-visible:ring-2 focus-visible:ring-gray-400 text-gray-800 transition-colors\"\n            :bubbleMenu=\"true\"\n            :content=\"_emailTemplate.response\"\n            @change=\"(val) => (_emailTemplate.response = val)\"\n            :placeholder=\"__('')\"\n          /> -->\n          <TextEditor\n            variant=\"outline\"\n            ref=\"content\"\n            :class=\"'rounded border border-gray-300 bg-white hover:border-gray-400 hover:shadow-sm focus:bg-white focus:border-gray-500 focus:shadow-sm focus:ring-0 focus-visible:ring-2 focus-visible:ring-gray-400 text-gray-800 transition-colors'\"\n            :editor-class=\"'!prose-sm max-w-none min-h-[7rem] overflow-auto py-1.5 px-2'\"\n            :content=\"_emailTemplate.response\"\n            @change=\"(val) => (_emailTemplate.response = val)\"\n            :starterkit-options=\"{ heading: { levels: [2, 3, 4, 5, 6] } }\"\n          >\n            <template v-slot:editor=\"{ editor }\">\n              <EditorContent\n                :class=\"'max-h-[50vh] overflow-y-auto py-3'\"\n                :editor=\"editor\"\n              />\n            </template>\n            <template v-slot:bottom>\n              <div class=\"flex flex-col gap-2\">\n                <div\n                  class=\"flex justify-between gap-2 overflow-hidden py-2.5 px-1\"\n                >\n                  <div class=\"flex items-center overflow-x-auto\">\n                    <TextEditorFixedMenu\n                      class=\"-ml-1\"\n                      :buttons=\"textEditorMenuButtons\"\n                    />\n                  </div>\n                </div>\n              </div>\n            </template>\n          </TextEditor>\n        </div>\n        <div>\n          <Checkbox v-model=\"_emailTemplate.enabled\" :label=\"__('Enabled')\" />\n        </div>\n        <ErrorMessage :message=\"__(errorMessage)\" />\n      </div>\n    </template>\n  </Dialog>\n</template>\n\n<script setup>\nimport { Checkbox, Select, TextEditorFixedMenu, TextEditor, call } from 'frappe-ui'\nimport { ref, nextTick, watch } from 'vue'\nimport { validateEmail } from '@/utils'\nimport { EditorContent } from '@tiptap/vue-3'\n\nconst props = defineProps({\n  emailTemplate: {\n    type: Object,\n    default: {},\n  },\n})\n\nconst show = defineModel()\nconst emailTemplates = defineModel('reloadEmailTemplates')\nconst errorMessage = ref('')\n\nconst emit = defineEmits(['after'])\n\nconst subjectRef = ref(null)\nconst nameRef = ref(null)\nconst editMode = ref(false)\nlet _emailTemplate = ref({})\n\nasync function updateEmailTemplate() {\n  if (!validate()) return\n  const old = { ...props.emailTemplate }\n  const newEmailTemplate = { ..._emailTemplate.value }\n\n  const nameChanged = old.name !== newEmailTemplate.name\n  delete old.name\n  delete newEmailTemplate.name\n\n  const otherFieldChanged =\n    JSON.stringify(old) !== JSON.stringify(newEmailTemplate)\n  const values = newEmailTemplate\n\n  if (!nameChanged && !otherFieldChanged) {\n    show.value = false\n    return\n  }\n\n  let name\n  if (nameChanged) {\n    name = await callRenameDoc()\n  }\n  if (otherFieldChanged) {\n    name = await callSetValue(values)\n  }\n  handleEmailTemplateUpdate({ name })\n}\n\nasync function callRenameDoc() {\n  const d = await call('frappe.client.rename_doc', {\n    doctype: 'Email Template',\n    old_name: props.emailTemplate.name,\n    new_name: _emailTemplate.value.name,\n  })\n  return d\n}\n\nasync function callSetValue(values) {\n  const d = await call('frappe.client.set_value', {\n    doctype: 'Email Template',\n    name: _emailTemplate.value.name,\n    fieldname: values,\n  })\n  return d.name\n}\n\nasync function callInsertDoc() {\n  if (!validate()) return\n  const doc = await call('frappe.client.insert', {\n    doc: {\n      doctype: 'Email Template',\n      ..._emailTemplate.value,\n    },\n  })\n  doc.name && handleEmailTemplateUpdate(doc)\n}\n\nfunction handleEmailTemplateUpdate(doc) {\n  emailTemplates.value?.reload()\n  show.value = false\n}\n\nfunction validate() {\n  if (!_emailTemplate.value.name) {\n    errorMessage.value = 'Name is required'\n    return false\n  }\n  if (!_emailTemplate.value.subject) {\n    errorMessage.value = 'Subject is required'\n    return false\n  }\n  if (\n    !_emailTemplate.value.response ||\n    _emailTemplate.value.response === '<p></p>'\n  ) {\n    errorMessage.value = 'Content is required'\n    return false\n  }\n  return true\n}\n\nwatch(\n  () => show.value,\n  (value) => {\n    if (!value) return\n    editMode.value = false\n    errorMessage.value = ''\n    nextTick(() => {\n      if (_emailTemplate.value.name) {\n        subjectRef.value.el.focus()\n      } else {\n        nameRef.value.el.focus()\n      }\n      _emailTemplate.value = { ...props.emailTemplate }\n      if (_emailTemplate.value.name) {\n        editMode.value = true\n      }\n    })\n  }\n)\nconst textEditorMenuButtons = [\n  'Paragraph',\n  ['Heading 2', 'Heading 3', 'Heading 4', 'Heading 5', 'Heading 6'],\n  'Separator',\n  'Bold',\n  'Italic',\n  'Separator',\n  'Bullet List',\n  'Numbered List',\n  'Separator',\n  'Align Left',\n  'Align Center',\n  'Align Right',\n  'FontColor',\n  'Separator',\n  'Image',\n  'Video',\n  'Link',\n  'Blockquote',\n  'Code',\n  'Horizontal Rule',\n  [\n    'InsertTable',\n    'AddColumnBefore',\n    'AddColumnAfter',\n    'DeleteColumn',\n    'AddRowBefore',\n    'AddRowAfter',\n    'DeleteRow',\n    'MergeCells',\n    'SplitCell',\n    'ToggleHeaderColumn',\n    'ToggleHeaderRow',\n    'ToggleHeaderCell',\n    'DeleteTable',\n  ],\n]\n</script>\n"],"names":["props","__props","show","_useModel","emailTemplates","errorMessage","ref","subjectRef","nameRef","editMode","_emailTemplate","updateEmailTemplate","validate","old","newEmailTemplate","nameChanged","otherFieldChanged","values","callRenameDoc","callSetValue","handleEmailTemplateUpdate","call","callInsertDoc","doc","_a","watch","value","nextTick","textEditorMenuButtons"],"mappings":"w9BAgHA,MAAMA,EAAQC,EAORC,EAAOC,gBAAY,EACnBC,EAAiBD,IAAY,sBAAsB,EACnDE,EAAeC,EAAI,EAAE,EAIrBC,EAAaD,EAAI,IAAI,EACrBE,EAAUF,EAAI,IAAI,EAClBG,EAAWH,EAAI,EAAK,EAC1B,IAAII,EAAiBJ,EAAI,EAAE,EAE3B,eAAeK,GAAsB,CACnC,GAAI,CAACC,EAAQ,EAAI,OACjB,MAAMC,EAAM,CAAE,GAAGb,EAAM,aAAe,EAChCc,EAAmB,CAAE,GAAGJ,EAAe,KAAO,EAE9CK,EAAcF,EAAI,OAASC,EAAiB,KAClD,OAAOD,EAAI,KACX,OAAOC,EAAiB,KAExB,MAAME,EACJ,KAAK,UAAUH,CAAG,IAAM,KAAK,UAAUC,CAAgB,EACnDG,EAASH,EAEf,GAAI,CAACC,GAAe,CAACC,EAAmB,CACtCd,EAAK,MAAQ,GACb,MACD,CAGGa,GACK,MAAMG,EAAe,EAE1BF,GACK,MAAMG,EAAaF,CAAM,EAElCG,EAAkC,CACpC,CAEA,eAAeF,GAAgB,CAM7B,OALU,MAAMG,EAAK,2BAA4B,CAC/C,QAAS,iBACT,SAAUrB,EAAM,cAAc,KAC9B,SAAUU,EAAe,MAAM,IACnC,CAAG,CAEH,CAEA,eAAeS,EAAaF,EAAQ,CAMlC,OALU,MAAMI,EAAK,0BAA2B,CAC9C,QAAS,iBACT,KAAMX,EAAe,MAAM,KAC3B,UAAWO,CACf,CAAG,GACQ,IACX,CAEA,eAAeK,GAAgB,CAC7B,GAAI,CAACV,EAAQ,EAAI,QACL,MAAMS,EAAK,uBAAwB,CAC7C,IAAK,CACH,QAAS,iBACT,GAAGX,EAAe,KACnB,CACL,CAAG,GACG,MAAQU,EAA6B,CAC3C,CAEA,SAASA,EAA0BG,EAAK,QACtCC,EAAApB,EAAe,QAAf,MAAAoB,EAAsB,SACtBtB,EAAK,MAAQ,EACf,CAEA,SAASU,GAAW,CAClB,OAAKF,EAAe,MAAM,KAIrBA,EAAe,MAAM,QAKxB,CAACA,EAAe,MAAM,UACtBA,EAAe,MAAM,WAAa,WAElCL,EAAa,MAAQ,sBACd,IAEF,IAVLA,EAAa,MAAQ,sBACd,KALPA,EAAa,MAAQ,mBACd,GAcX,CAEAoB,EACE,IAAMvB,EAAK,MACVwB,GAAU,CACJA,IACLjB,EAAS,MAAQ,GACjBJ,EAAa,MAAQ,GACrBsB,EAAS,IAAM,CACTjB,EAAe,MAAM,KACvBH,EAAW,MAAM,GAAG,MAAO,EAE3BC,EAAQ,MAAM,GAAG,MAAO,EAE1BE,EAAe,MAAQ,CAAE,GAAGV,EAAM,aAAe,EAC7CU,EAAe,MAAM,OACvBD,EAAS,MAAQ,GAEzB,CAAK,EACF,CACH,EACA,MAAMmB,EAAwB,CAC5B,YACA,CAAC,YAAa,YAAa,YAAa,YAAa,WAAW,EAChE,YACA,OACA,SACA,YACA,cACA,gBACA,YACA,aACA,eACA,cACA,YACA,YACA,QACA,QACA,OACA,aACA,OACA,kBACA,CACE,cACA,kBACA,iBACA,eACA,eACA,cACA,YACA,aACA,YACA,qBACA,kBACA,mBACA,aACD,CACH"}