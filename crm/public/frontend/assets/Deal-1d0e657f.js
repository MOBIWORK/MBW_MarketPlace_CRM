import{_ as we,a as Ie,A as ze,b as Ve,L as $e,S as Ue,c as De,d as Ae}from"./SLASection-54c47357.js";import{g as Se,a as Ee,B as O,T as Be,U as Ne,o as Te,r as y,A,d as R,e as u,f as _,j as t,l as h,i as r,q as p,h as o,F as L,b,c as z,V as P,P as q,W as Me,X as je,Y as Fe,Z as Oe,n as S,D as K,$ as Re,v as m,x as C,a0 as Le,t as V,p as Q,a2 as E,a3 as Pe,k as ee,a4 as ae,a6 as qe,at as We,E as te,aj as Ge}from"./index-d53336e9.js";import{I as Xe}from"./IndicatorIcon-56c34b08.js";import{S as Ye}from"./Fields-d02fad9b.js";import{_ as Ze,a as He}from"./LayoutHeader-5e7d45d2.js";import{_ as Je}from"./OrganizationModal-9b1bcc13.js";import{s as Ke,_ as Qe}from"./statuses-c8dcc01d.js";import{C as ea}from"./ContactModal-cbfd0dcc.js";import{_ as aa}from"./CustomActions-d94ef330.js";import{o as ta}from"./organizations-9991fda4.js";import{c as se,w as sa}from"./settings-f5b76535.js";import{_ as oa}from"./Tabs-b8fbea28.js";import"./FileUploader-d14b0926.js";import"./FadedScrollableDiv-5ec677da.js";import"./CalendarIcon-9f83cf66.js";import"./EmailTemplateModal-4014cb5a.js";import"./TaskModal-a206b05a.js";import"./DatetimePicker-7fc9cdc9.js";import"./EditIcon-d614e42f.js";const la={key:1,class:"flex h-full overflow-hidden"},na={class:"flex items-center justify-start gap-5 border-b p-5"},ia={class:"group relative size-12"},ra={class:"flex flex-col gap-2.5 truncate"},da={class:"truncate text-2xl font-medium"},ua={class:"flex gap-1.5"},ma={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},ca={class:"flex flex-col overflow-y-auto"},_a={key:0,class:"pr-2"},pa={key:1},fa={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},ga={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},va=["onClick"],ya={class:"truncate"},ha={class:"flex items-center"},xa={class:"flex flex-col gap-1.5 text-base text-gray-800"},ba={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Ca={class:"flex items-center gap-3 p-1 py-1.5"},ka={key:0,class:"mx-2 h-px border-t border-gray-200"},wa={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},qa={__name:"Deal",props:{dealId:{type:String,required:!0}},setup(oe){const{$dialog:le,makeCall:ne}=Se(),{organizations:ie,getOrganization:re}=ta(),{statusOptions:de,getDealStatus:ue}=Ke(),$=Ee(),f=oe,s=O({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:f.dealId},cache:["deal",f.dealId],onSuccess:a=>{Be(a),Ne(a,{doc:a,$dialog:le,router:$,updateField:w,createToast:b,deleteDoc:be,call:z})}});Te(()=>{s.data||s.fetch()});function me(){s.fetch()}const B=y(!1),N=y(!1),T=y(!1),M=y({}),k=A(()=>{var a;return((a=s.data)==null?void 0:a.organization)&&re(s.data.organization)});function ce(a,e,d){e=Array.isArray(a)?"":e,!_e(a,e)&&O({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:f.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{s.reload(),B.value=!0,b({title:__("Deal updated"),icon:"check",iconClasses:"text-green-600"}),d==null||d()},onError:n=>{var g;b({title:__("Error updating deal"),text:__((g=n.messages)==null?void 0:g[0]),icon:"x",iconClasses:"text-red-600"})}})}function _e(a,e){var n;let d=s.data.all_fields||{};return(n=d[a])!=null&&n.reqd&&!e?(b({title:__("Error Updating Deal"),text:__("{0} is a required field",[d[a].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const pe=A(()=>{var e;let a=[{label:__("Deals"),route:{name:"Deals"}}];return a.push({label:((e=k.value)==null?void 0:e.name)||__("Untitled"),route:{name:"Deal",params:{dealId:s.data.name}}}),a}),U=y(0),fe=A(()=>[{name:"Activity",label:__("Activity"),icon:ze},{name:"Emails",label:__("Emails"),icon:P},{name:"Calls",label:__("Calls"),icon:q,condition:()=>se.value},{name:"Tasks",label:__("Tasks"),icon:Me},{name:"Notes",label:__("Notes"),icon:je},{name:"WhatsApp",label:__("WhatsApp"),icon:Fe,condition:()=>sa.value}].filter(e=>e.condition?e.condition():!0)),j=A(()=>{let a=s.data;return a?ge(a.doctype_fields,x.data):[]});function ge(a,e){return a.forEach(d=>{d.name=="contacts_tab"?(delete d.fields,d.contacts=(e==null?void 0:e.map(n=>({name:n.name,full_name:n.full_name,email:n.email,mobile_no:n.mobile_no,image:n.image,is_primary:n.is_primary,opened:!1})))||[]):d.fields.forEach(n=>{n.name=="organization"&&(n.create=(g,i)=>{M.value.organization_name=g,N.value=!0,i()},n.link=g=>$.push({name:"Organization",params:{organizationId:g}}))})}),a}const F=y(!1),W=y({});function ve(a){let e=[{label:__("Delete"),icon:"trash-2",onClick:()=>ye(a)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:Ge(Ye,{class:"h-4 w-4"}),onClick:()=>he(a)}),e}async function G(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:f.dealId,contact:a})&&(x.reload(),b({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function ye(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:f.dealId,contact:a})&&(x.reload(),b({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function he(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:f.dealId,contact:a})&&(x.reload(),b({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const x=O({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:f.dealId},cache:["deal_contacts",f.dealId],auto:!0});function xe(){var d;let a=(d=x.data)==null?void 0:d.find(n=>n.is_primary),e=a.mobile_no||null;if(!a){E(__("No primary contact set"));return}if(!e){E(__("No mobile number set"));return}ne(e)}function w(a,e,d){ce(a,e,()=>{s.data[a]=e,d==null||d()})}async function be(a){await z("frappe.client.delete",{doctype:"CRM Deal",name:a}),$.push({name:"Deals"})}const X=y(null);function Ce(){X.value.emailBox.show=!0}return(a,e)=>{const d=R("FeatherIcon"),n=R("Button"),g=R("Badge");return u(),_(L,null,[t(s).data?(u(),h(Ze,{key:0},{"left-header":r(()=>[o(t(He),{items:pe.value},null,8,["items"])]),"right-header":r(()=>{var i;return[t(s).data._customActions?(u(),h(aa,{key:0,actions:t(s).data._customActions},null,8,["actions"])):p("",!0),(u(),h(Oe(((i=t(s).data._assignedTo)==null?void 0:i.length)==1?"Button":"div"),null,{default:r(()=>[o(Qe,{avatars:t(s).data._assignedTo,onClick:e[0]||(e[0]=l=>T.value=!0)},null,8,["avatars"])]),_:1})),o(t(K),{options:t(de)("deal",w)},{default:r(({open:l})=>[o(n,{label:t(s).data.status,class:S(t(ue)(t(s).data.status).colorClass)},{prefix:r(()=>[o(Xe)]),suffix:r(()=>[o(d,{name:l?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])]}),_:1})):p("",!0),t(s).data?(u(),_("div",la,[o(t(oa),{modelValue:U.value,"onUpdate:modelValue":e[4]||(e[4]=i=>U.value=i),tabs:fe.value},{default:r(({tab:i})=>[o(Ve,{ref_key:"activities",ref:X,doctype:"CRM Deal",title:i.name,reload:B.value,"onUpdate:reload":e[1]||(e[1]=l=>B.value=l),tabIndex:U.value,"onUpdate:tabIndex":e[2]||(e[2]=l=>U.value=l),modelValue:t(s),"onUpdate:modelValue":e[3]||(e[3]=l=>Re(s)?s.value=l:null)},null,8,["title","reload","tabIndex","modelValue"])]),_:1},8,["modelValue","tabs"]),o(we,{side:"right",class:"flex flex-col justify-between border-l"},{default:r(()=>{var i;return[m("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium",onClick:e[5]||(e[5]=l=>t(Le)(t(s).data.name))},C(a.__(t(s).data.name)),1),m("div",na,[o(t(V),{text:a.__("Organization logo")},{default:r(()=>{var l,D;return[m("div",ia,[o(t(Q),{size:"3xl",class:"size-12",label:((l=k.value)==null?void 0:l.name)||a.__("Untitled"),image:(D=k.value)==null?void 0:D.organization_logo},null,8,["label","image"])])]}),_:1},8,["text"]),m("div",ra,[o(t(V),{text:((i=k.value)==null?void 0:i.name)||a.__("Set an organization")},{default:r(()=>{var l;return[m("div",da,C(((l=k.value)==null?void 0:l.name)||a.__("Untitled")),1)]}),_:1},8,["text"]),m("div",ua,[t(se)?(u(),h(t(V),{key:0,text:a.__("Make a call")},{default:r(()=>[o(n,{class:"h-7 w-7",onClick:xe},{default:r(()=>[o(q,{class:"h-4 w-4"})]),_:1})]),_:1},8,["text"])):p("",!0),o(t(V),{text:a.__("Send an email")},{default:r(()=>[o(n,{class:"h-7 w-7"},{default:r(()=>[o(P,{class:"h-4 w-4",onClick:e[6]||(e[6]=l=>t(s).data.email?Ce():t(E)(a.__("No email set")))})]),_:1})]),_:1},8,["text"]),o(t(V),{text:a.__("Go to website")},{default:r(()=>[o(n,{class:"h-7 w-7"},{default:r(()=>[o($e,{class:"h-4 w-4",onClick:e[7]||(e[7]=l=>t(s).data.website?t(Pe)(t(s).data.website):t(E)(a.__("No website set")))})]),_:1})]),_:1},8,["text"])])])]),t(s).data.sla_status?(u(),h(Ue,{key:0,modelValue:t(s).data,"onUpdate:modelValue":e[8]||(e[8]=l=>t(s).data=l),onUpdateField:w},null,8,["modelValue"])):p("",!0),j.value.length?(u(),_("div",ma,[m("div",ca,[(u(!0),_(L,null,ee(j.value,(l,D)=>(u(),_("div",{key:l.label,class:S(["flex flex-col p-3",{"border-b":D!==j.value.length-1}])},[o(ae,{"is-opened":l.opened,label:l.label},{actions:r(()=>[l.contacts?(u(),_("div",_a,[o(qe,{value:"",doctype:"Contact",onChange:e[9]||(e[9]=v=>G(v)),onCreate:(v,I)=>{W.value={first_name:v,company_name:t(s).data.organization},F.value=!0,I()}},{target:r(({togglePopover:v})=>[o(n,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:I=>v()},null,8,["onClick"])]),_:1},8,["onCreate"])])):p("",!0)]),default:r(()=>{var v,I,Y;return[l.fields?(u(),h(De,{key:0,fields:l.fields,modelValue:t(s).data,"onUpdate:modelValue":e[10]||(e[10]=c=>t(s).data=c),onUpdate:w},null,8,["fields","modelValue"])):(u(),_("div",pa,[(v=t(x))!=null&&v.loading&&((Y=(I=t(x))==null?void 0:I.data)==null?void 0:Y.length)==0?(u(),_("div",fa,[o(Ae,{class:"h-4 w-4"}),m("span",null,C(a.__("Loading...")),1)])):l.contacts.length?(u(!0),_(L,{key:1},ee(l.contacts,(c,Z)=>(u(),_("div",{key:c.name},[m("div",{class:S(["px-2 pb-2.5",[Z==0?"pt-5":"pt-2.5"]])},[o(ae,{"is-opened":c.opened},{header:r(({opened:ke,toggle:H})=>[m("div",ga,[m("div",{class:"flex h-7 items-center gap-2 truncate",onClick:J=>H()},[o(t(Q),{label:c.full_name,image:c.image,size:"md"},null,8,["label","image"]),m("div",ya,C(c.full_name),1),c.is_primary?(u(),h(g,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):p("",!0)],8,va),m("div",ha,[o(t(K),{options:ve(c.name)},{default:r(()=>[o(n,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),o(n,{variant:"ghost",onClick:J=>t($).push({name:"Contact",params:{contactId:c.name}})},{default:r(()=>[o(We,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),o(n,{variant:"ghost",onClick:J=>H()},{default:r(()=>[o(d,{name:"chevron-right",class:S(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":ke}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:r(()=>[m("div",xa,[m("div",ba,[o(P,{class:"h-4 w-4"}),te(" "+C(c.email),1)]),m("div",Ca,[o(q,{class:"h-4 w-4"}),te(" "+C(c.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),Z!=l.contacts.length-1?(u(),_("div",ka)):p("",!0)]))),128)):(u(),_("div",wa,C(a.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):p("",!0)]}),_:1})])):p("",!0),o(Je,{modelValue:N.value,"onUpdate:modelValue":e[11]||(e[11]=i=>N.value=i),organization:M.value,"onUpdate:organization":e[12]||(e[12]=i=>M.value=i),options:{redirect:!1,afterInsert:i=>w("organization",i.name,()=>{t(ie).reload()})}},null,8,["modelValue","organization","options"]),o(ea,{modelValue:F.value,"onUpdate:modelValue":e[13]||(e[13]=i=>F.value=i),contact:W.value,options:{redirect:!1,afterInsert:i=>G(i.name)}},null,8,["modelValue","contact","options"]),t(s).data?(u(),h(Ie,{key:2,doc:t(s).data,modelValue:T.value,"onUpdate:modelValue":e[14]||(e[14]=i=>T.value=i),assignees:t(s).data._assignedTo,"onUpdate:assignees":e[15]||(e[15]=i=>t(s).data._assignedTo=i),onUpdate:me},null,8,["doc","modelValue","assignees"])):p("",!0)],64)}}};export{qa as default};
//# sourceMappingURL=Deal-1d0e657f.js.map
